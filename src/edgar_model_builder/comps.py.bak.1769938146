import pandas as pd
from .marketdata import MarketDataProvider
from .normalize import compute_kpis

def build_comps_table(target_ticker: str, peers: list[str], kpis_by_ticker: dict[str, dict], mkt: MarketDataProvider):
    rows = []
    for t in [target_ticker] + peers:
        q = mkt.quote(t)
        k = kpis_by_ticker.get(t, {})
        ttm_rev = k.get("ttm_revenue")
        ttm_ebitda = k.get("ttm_ebitda")
        mcap = q.market_cap
        ev = None
        if mcap is not None:
            cash = k.get("cash")
            debt = k.get("total_debt")
            if cash is not None or debt is not None:
                ev = mcap + (debt or 0.0) - (cash or 0.0)
            else:
                ev = mcap
        ev_rev = (ev / ttm_rev) if (ev is not None and ttm_rev) else None
        ev_ebitda = (ev / ttm_ebitda) if (ev is not None and ttm_ebitda) else None
        rows.append({
            "ticker": t,
            "price": q.price,
            "market_cap": mcap,
            "ev": ev,
            "ttm_revenue": ttm_rev,
            "ttm_ebitda": ttm_ebitda,
            "EV/Revenue": ev_rev,
            "EV/EBITDA": ev_ebitda,
        })
    df = pd.DataFrame(rows)
    return df
